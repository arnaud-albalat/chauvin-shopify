{% schema %}
{
  "name": "Map Departments",
  "settings": [
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Titre"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Avec plus de 15.000 étudiants en santé inscrits dans toute la France, nous avons accompagné des milliers de familles sur tout le territoire.</p>"
    },
    {
      "type": "header",
      "content": "Map Colors"
    },
    {
      "type": "color",
      "id": "hover_color",
      "label": "Hover Color",
      "default": "#BA6C46"
    },
    {
      "type": "color",
      "id": "base_color",
      "label": "Base Department Color",
      "default": "#1e3932"
    },
    {
      "type": "color",
      "id": "stroke_color",
      "label": "Stroke Color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Map Departments"
    }
  ]
}
{% endschema %}

<div class="map-departments-wrapper page-width">
  <div class="map-departments-grid">
    <div class="map-column">
      <div class="france-map-container">
        {% render 'france-map' %}
        <div id="department-tooltip" class="department-tooltip"></div>
      </div>
    </div>
    <div class="content-column">
      {% if section.settings.heading != blank %}
        <h2 class="title h1 map-title">{{ section.settings.heading }}</h2>
      {% endif %}
      
      {% if section.settings.description != blank %}
        <div class="map-description rte">
          {{ section.settings.description }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .map-departments-wrapper {
    padding-top: 60px;
    padding-bottom: 60px;
  }

  .map-departments-grid {
    display: flex;
    flex-direction: column;
    gap: 40px;
    align-items: center;
  }

  /* SVG Styling */
  .france-map-container {
    position: relative;
    width: 425px;
    max-width: 100%;
    margin: 0 auto;
  }

  @media screen and (max-width: 500px) {
    .france-map-container {
      width: 300px;
    }
  }

  .france-map-container svg {
    width: 100%;
    height: auto;
    display: block;
  }

  .departement {
    fill: {{ section.settings.base_color }};
    stroke: {{ section.settings.stroke_color }};
    stroke-width: 1px;
    cursor: pointer;
    transition: fill 0.3s ease;
  }

  .departement:hover {
    fill: {{ section.settings.hover_color }};
  }

  .content-column {
    text-align: center;
  }

  .map-title {
    margin-bottom: 20px;
    margin-top: 0px;
  }

  .map-title strong {
    color: {{ section.settings.hover_color }};
    font-weight: inherit;
  }

  .map-description {
  }

  /* Tooltip Styling */
  .department-tooltip {
    position: fixed;
    display: none;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    pointer-events: none;
    z-index: 1000;
    transform: translate(-50%, -100%);
    margin-top: -10px;
    white-space: nowrap;
  }

  /* Desktop Layout */
  @media screen and (min-width: 990px) {
    .map-departments-grid {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 80px;
    }

    .map-column {
      flex: 0 0 auto;
      width: auto;
    }

    .france-map-container {
      margin: 0;
    }

    .content-column {
      flex: 0 1 auto;
      max-width: 450px;
      text-align: left;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const departments = document.querySelectorAll('.departement');
  const tooltip = document.getElementById('department-tooltip');

  departments.forEach(dept => {
    // Tooltip behavior
    dept.addEventListener('mouseenter', (e) => {
      const name = dept.getAttribute('data-nom');
      if (name) {
        tooltip.textContent = name;
        tooltip.style.display = 'block';
      }
    });

    dept.addEventListener('mousemove', (e) => {
      tooltip.style.left = e.clientX + 'px';
      tooltip.style.top = e.clientY + 'px';
    });

    dept.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
      tooltip.textContent = ''; // Clear content
    });

    // Navigation behavior
    dept.addEventListener('click', () => {
      let slug = '';
      const classes = dept.classList;
      
      // Look for slug in class list
      for (let i = 0; i < classes.length; i++) {
        const cls = classes[i];
         if (cls === 'departement') continue;
         if (cls.match(/^departement-\d+$/)) continue; // skip dept number
         if (cls.match(/^departement-[a-zA-Z0-9-]+$/)) {
             slug = cls.replace('departement-', '');
         }
      }
      
      // Fallback: slugify data-nom
      if (!slug) {
         const name = dept.getAttribute('data-nom');
         if (name) {
            slug = name.toLowerCase()
                  .replace(/ /g, '-')
                  .replace(/'/g, '')
                  .replace(/[àâä]/g, 'a')
                  .replace(/[éèêë]/g, 'e')
                  .replace(/[îï]/g, 'i')
                  .replace(/[ôö]/g, 'o')
                  .replace(/[ùûü]/g, 'u')
                  .replace(/[ç]/g, 'c');
         }
      }

      if (slug) {
        window.location.href = '/pages/' + slug;
      }
    });
  });
});
</script>
